<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #1e40af;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1e3a8a;
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: #16a34a; }
        .error { color: #dc2626; }
        .info { color: #0ea5e9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Diagnostic Firebase - Ã‰lectro-Actu</h1>
        <p>Ce script va tester votre connexion Firebase et crÃ©er un utilisateur de test.</p>
        
        <button onclick="testFirebaseConnection()">1ï¸âƒ£ Tester la connexion Firebase</button>
        <button onclick="testCreateUser()">2ï¸âƒ£ CrÃ©er utilisateur de test</button>
        <button onclick="listUsers()">3ï¸âƒ£ Lister les utilisateurs Auth</button>
        <button onclick="checkFirestoreRules()">4ï¸âƒ£ Tester les rÃ¨gles Firestore</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAlBDedWLbHG-3UnijsSfocm77sNpn15Wg",
            authDomain: "electroactu-b6050.firebaseapp.com",
            projectId: "electroactu-b6050",
            storageBucket: "electroactu-b6050.firebasestorage.app",
            messagingSenderId: "890343912768",
            appId: "1:890343912768:web:87de595f6df3c3f434f6a5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        // Test 1 : Connexion Firebase
        window.testFirebaseConnection = function() {
            clearResults();
            log('ğŸ” TEST DE CONNEXION FIREBASE', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            try {
                log(`âœ… App initialisÃ©e`, 'success');
                log(`ğŸ“¦ Project ID: ${firebaseConfig.projectId}`, 'info');
                log(`ğŸ”‘ Auth Domain: ${firebaseConfig.authDomain}`, 'info');
                log(`ğŸ—„ï¸  Auth: ${auth ? 'ConnectÃ©' : 'Non connectÃ©'}`, auth ? 'success' : 'error');
                log(`ğŸ’¾ Firestore: ${db ? 'ConnectÃ©' : 'Non connectÃ©'}`, db ? 'success' : 'error');
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        log(`ğŸ‘¤ Utilisateur actuellement connectÃ©: ${user.email} (UID: ${user.uid})`, 'success');
                    } else {
                        log(`ğŸ‘¤ Aucun utilisateur connectÃ©`, 'info');
                    }
                });
                
            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`, 'error');
            }
        };

        // Test 2 : CrÃ©er utilisateur
        window.testCreateUser = async function() {
            clearResults();
            log('ğŸ‘¤ TEST CRÃ‰ATION UTILISATEUR', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            const timestamp = Date.now();
            const testEmail = `test${timestamp}@electroactu.com`;
            const testPassword = 'Test123456!';
            const testName = `Test User ${timestamp}`;
            
            log(`ğŸ“§ Email de test: ${testEmail}`, 'info');
            log(`ğŸ” Mot de passe: ${testPassword}`, 'info');
            
            try {
                // Ã‰tape 1: CrÃ©er dans Auth
                log('ğŸ“ Ã‰TAPE 1/4: CrÃ©ation compte Auth...', 'info');
                const userCredential = await createUserWithEmailAndPassword(auth, testEmail, testPassword);
                const user = userCredential.user;
                log(`âœ… Compte Auth crÃ©Ã©! UID: ${user.uid}`, 'success');
                
                // Ã‰tape 2: Update profil
                log('ğŸ“ Ã‰TAPE 2/4: Mise Ã  jour profil...', 'info');
                await updateProfile(user, { displayName: testName });
                log(`âœ… Profil mis Ã  jour: ${testName}`, 'success');
                
                // Ã‰tape 3: CrÃ©er document Firestore
                log('ğŸ“ Ã‰TAPE 3/4: CrÃ©ation document Firestore...', 'info');
                const userDocRef = doc(db, 'users', user.uid);
                log(`ğŸ“„ Chemin: users/${user.uid}`, 'info');
                
                const userData = {
                    name: testName,
                    email: testEmail,
                    role: 'user',
                    photoURL: null,
                    createdAt: serverTimestamp()
                };
                
                await setDoc(userDocRef, userData);
                log(`âœ… Document Firestore crÃ©Ã©!`, 'success');
                
                // Ã‰tape 4: VÃ©rification
                log('ğŸ“ Ã‰TAPE 4/4: VÃ©rification...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const verifyDoc = await getDoc(userDocRef);
                if (verifyDoc.exists()) {
                    log(`âœ…âœ…âœ… SUCCÃˆS TOTAL! Document vÃ©rifiÃ©`, 'success');
                    log(`ğŸ“Š DonnÃ©es: ${JSON.stringify(verifyDoc.data(), null, 2)}`, 'success');
                    log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'success');
                    log(`ğŸ‰ TOUT FONCTIONNE PARFAITEMENT!`, 'success');
                    log(`ğŸ“ Allez maintenant dans Firebase Console:`, 'info');
                    log(`   1. Authentication â†’ Users`, 'info');
                    log(`   2. Firestore Database â†’ users`, 'info');
                    log(`   Vous devriez voir cet utilisateur.`, 'info');
                } else {
                    log(`âŒ PROBLÃˆME: Document non trouvÃ© aprÃ¨s crÃ©ation`, 'error');
                    log(`âš ï¸ Le compte Auth existe mais pas le document Firestore`, 'error');
                    log(`ğŸ”§ Solution: VÃ©rifiez les rÃ¨gles Firestore`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ERREUR: ${error.code}`, 'error');
                log(`ğŸ“ Message: ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'error');
                    log(`âš ï¸ PROBLÃˆME DE PERMISSIONS FIRESTORE!`, 'error');
                    log(``, 'error');
                    log(`ğŸ”§ SOLUTION:`, 'error');
                    log(`1. Allez sur Firebase Console`, 'error');
                    log(`2. Firestore Database â†’ Rules`, 'error');
                    log(`3. Ajoutez cette rÃ¨gle:`, 'error');
                    log(``, 'error');
                    log(`match /users/{userId} {`, 'error');
                    log(`  allow create: if request.auth.uid == userId;`, 'error');
                    log(`  allow read: if request.auth != null;`, 'error');
                    log(`}`, 'error');
                }
            }
        };

        // Test 3: Lister les utilisateurs (nÃ©cessite admin)
        window.listUsers = async function() {
            clearResults();
            log('ğŸ“‹ LISTE DES UTILISATEURS FIRESTORE', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                
                if (usersSnapshot.empty) {
                    log(`âš ï¸ Aucun utilisateur trouvÃ© dans Firestore`, 'error');
                    log(``, 'info');
                    log(`Cela peut signifier:`, 'info');
                    log(`1. Aucun compte n'a encore Ã©tÃ© crÃ©Ã©`, 'info');
                    log(`2. Les documents n'ont pas Ã©tÃ© crÃ©Ã©s (problÃ¨me de rÃ¨gles)`, 'info');
                    log(`3. Vous n'avez pas les permissions de lecture`, 'info');
                } else {
                    log(`âœ… ${usersSnapshot.size} utilisateur(s) trouvÃ©(s):`, 'success');
                    log(``, 'info');
                    
                    usersSnapshot.forEach((doc) => {
                        const data = doc.data();
                        log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
                        log(`ğŸ“§ Email: ${data.email}`, 'info');
                        log(`ğŸ‘¤ Nom: ${data.name}`, 'info');
                        log(`ğŸ”‘ UID: ${doc.id}`, 'info');
                        log(`ğŸ‘‘ RÃ´le: ${data.role}`, 'info');
                        log(`ğŸ“… CrÃ©Ã©: ${data.createdAt?.toDate?.() || 'N/A'}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`âŒ ERREUR: ${error.code}`, 'error');
                log(`ğŸ“ Message: ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log(`âš ï¸ Vous n'avez pas la permission de lire la collection 'users'`, 'error');
                }
            }
        };

        // Test 4: Tester les rÃ¨gles Firestore
        window.checkFirestoreRules = async function() {
            clearResults();
            log('ğŸ” TEST DES RÃˆGLES FIRESTORE', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            const currentUser = auth.currentUser;
            
            if (!currentUser) {
                log(`âš ï¸ Aucun utilisateur connectÃ©`, 'error');
                log(`ğŸ“ CrÃ©ez d'abord un utilisateur avec le bouton 2ï¸âƒ£`, 'info');
                return;
            }
            
            log(`ğŸ‘¤ Utilisateur connectÃ©: ${currentUser.email}`, 'success');
            log(`ğŸ”‘ UID: ${currentUser.uid}`, 'info');
            log(``, 'info');
            
            // Test 1: Lecture de son propre document
            log(`TEST 1: Lecture de son propre document...`, 'info');
            try {
                const docRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    log(`âœ… Lecture rÃ©ussie`, 'success');
                } else {
                    log(`âš ï¸ Document n'existe pas`, 'error');
                }
            } catch (error) {
                log(`âŒ Ã‰chec: ${error.code}`, 'error');
            }
            
            log(``, 'info');
            
            // Test 2: Ã‰criture dans son propre document
            log(`TEST 2: Ã‰criture dans son propre document...`, 'info');
            try {
                const docRef = doc(db, 'users', currentUser.uid);
                await setDoc(docRef, { testField: 'test' }, { merge: true });
                log(`âœ… Ã‰criture rÃ©ussie`, 'success');
            } catch (error) {
                log(`âŒ Ã‰chec: ${error.code}`, 'error');
            }
            
            log(``, 'info');
            log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
            log(`ğŸ“Š RÃ©sumÃ© des tests terminÃ©`, 'success');
        };
    </script>
</body>
</html>
